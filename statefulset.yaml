apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: nibiru-node
  namespace: nibiru
spec:
  selector:
    matchLabels:
      app: nibiru-node 
  serviceName: "nibiru-node"
  replicas: 1 
  minReadySeconds: 10 
  template:
    metadata:
      labels:
        app: nibiru-node 
    spec:
      terminationGracePeriodSeconds: 10
      initContainers:
        - name: init-node-key
          image: ghcr.io/nibiruchain/nibiru:latest
          env:
            - name: KEYPASSWD
              valueFrom:
                secretKeyRef:
                  name: validator-key
                  key: password
          securityContext:
            runAsUser: 0
          command: ["/bin/sh","-c"]
          args:
            - >
              set -x;
              apk add sed
              alias nibid=/usr/local/bin/nibid;
              nibid init G_XBT --chain-id=nibiru-itn-1 --home /data;
              (echo $KEYPASSWD; echo $KEYPASSWD) | nibid keys add g-key &> /data/key.txt;
              wget -O /data/config/addrbook.json https://snapshot.silentvalidator.com/testnet/nibiru/addrbook.json;
              nibid tendermint unsafe-reset-all --home /data --keep-addr-book;
          volumeMounts:
            - name: chain-data
              mountPath: /data
        - name: init-node-curl
          image: alpine:latest
          securityContext:
            runAsUser: 0
          command: ["/bin/sh","-c"]
          args:
            - >
              set -x;
              apk add curl;
              apk add wget;
              apk add lz4;
              curl -s https://networks.itn.nibiru.fi/nibiru-itn-1/genesis > /data/config/genesis.json;
              sed -i 's|seeds =.*|seeds = "'$(curl -s https://networks.itn.nibiru.fi/nibiru-itn-1/seeds)'"|g' /data/config/config.toml;
              sed -i 's/minimum-gas-prices =.*/minimum-gas-prices = "0.025unibi"/g' /data/config/app.toml;
              sed -i 's|enable =.*|enable = true|g' /data/config/config.toml;
              sed -i 's|rpc_servers =.*|rpc_servers = "'$(curl -s https://networks.itn.nibiru.fi/nibiru-itn-1/rpc_servers)'"|g' /data/config/config.toml;
              sed -i 's|trust_height =.*|trust_height = "'$(curl -s https://networks.itn.nibiru.fi/nibiru-itn-1/trust_height)'"|g' /data/config/config.toml;
              sed -i 's|trust_hash =.*|trust_hash = "'$(curl -s https://networks.itn.nibiru.fi/nibiru-itn-1/trust_hash)'"|g' /data/config/config.toml;
              wget -O nibiru.tar.lz4 https://snapshot.silentvalidator.com/testnet/nibiru/nibiru-2023-03-07T07%3A24.tar.lz4 --inet4-only;
              lz4 -c -d nibiru.tar.lz4  | tar -x -C /data;
          volumeMounts:
            - name: chain-data
              mountPath: /data
      containers:
      - name: nibiru-node 
        image: ghcr.io/nibiruchain/nibiru:0.19.2
        securityContext:
            runAsUser: 0
        command: ["/usr/local/bin/nibid","start"]
        args:
          - --home=/data
          - --rpc.unsafe 
          - --rpc.laddr=tcp://0.0.0.0:26657
          - --rpc.grpc_laddr=tcp://0.0.0.0:26658
        ports:
        - containerPort: 26657
          name: rpc-port
        - containerPort: 26658
          name: grpc-port
        resources:
          limits:
                memory: 6G
                cpu: 4
          requests:
                memory: 1G
                cpu: 0.5
        readinessProbe:
          tcpSocket:
            port: 26657
          initialDelaySeconds: 5
          periodSeconds: 10
        livenessProbe:
          tcpSocket:
            port: 26657
          initialDelaySeconds: 15
          periodSeconds: 20
        volumeMounts:
        - name: chain-data
          mountPath: /data 
      volumes:
        - name: chain-data
          persistentVolumeClaim:
            claimName: nibiru-node-pvc

